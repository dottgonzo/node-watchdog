"use strict";
var Promise = require('bluebird');
var fs = require('fs');
var systemd_services_1 = require('systemd-services');
var ns = new systemd_services_1.default();
var watchDog = (function () {
    function watchDog(o) {
        if (o)
            this.configure(o);
    }
    watchDog.prototype.configure = function (o) {
        var _this = this;
        if (!o) {
            throw Error('no configuration provided for watchdog');
        }
        else {
            if (!o.configFile)
                o.configFile = '/etc/watchdog.conf';
            _this.configFile = o.configFile;
            var conf = 'realtime = yes\n';
            conf += 'priority = 1\n';
            if (o.pings) {
                for (var i = 0; i < o.pings.length; i++) {
                    conf += 'ping = ' + o.pings[i] + '\n';
                }
            }
            if (o.files) {
                for (var i = 0; i < o.files.length; i++) {
                    if (o.files[i].name && o.files[i].change) {
                        conf += 'file = ' + o.files[i].name + '\n';
                        conf += 'change = ' + o.files[i].change + '\n';
                    }
                    else {
                        throw Error('you must specify filename and change timer');
                    }
                }
            }
            if (o.pidFile) {
                conf += 'pidfile = ' + o.pidFile + '\n';
            }
            if (o.repairBinary) {
                conf += 'repair-binary = ' + o.repairBinary + '\n';
            }
            fs.writeFileSync(_this.configFile, conf, { encoding: 'utf-8' });
        }
    };
    watchDog.prototype.start = function () {
        var _this = this;
        return new Promise(function (resolve, reject) {
            ns.start('watchdog').then(function (a) {
                resolve(a);
            }).catch(function (err) {
                reject(err);
            });
        });
    };
    watchDog.prototype.stop = function () {
        var _this = this;
        return new Promise(function (resolve, reject) {
            ns.stop('watchdog').then(function (a) {
                resolve(a);
            }).catch(function (err) {
                reject(err);
            });
        });
    };
    watchDog.prototype.restart = function () {
        var _this = this;
        return new Promise(function (resolve, reject) {
            _this.stop().then(function () {
                _this.start().then(function (a) {
                    resolve(a);
                }).catch(function (err) {
                    reject(err);
                });
            }).catch(function (err) {
                _this.start().then(function (a) {
                    resolve(a);
                }).catch(function (err) {
                    reject(err);
                });
            });
        });
    };
    return watchDog;
}());
Object.defineProperty(exports, "__esModule", { value: true });
exports.default = watchDog;

//# sourceMappingURL=data:application/json;base64,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b0JBQ1QsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFBO2dCQUNmLENBQUMsQ0FBQyxDQUFBO1lBQ04sQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLFVBQUMsR0FBRztnQkFDVCxLQUFLLENBQUMsS0FBSyxFQUFFLENBQUMsSUFBSSxDQUFDLFVBQUMsQ0FBQztvQkFDakIsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFBO2dCQUNkLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxVQUFDLEdBQUc7b0JBQ1QsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFBO2dCQUNmLENBQUMsQ0FBQyxDQUFBO1lBQ04sQ0FBQyxDQUFDLENBQUE7UUFFTixDQUFDLENBQUMsQ0FBQTtJQUVOLENBQUM7SUFHTCxlQUFDO0FBQUQsQ0ExR0EsQUEwR0MsSUFBQTtBQTFHRDswQkEwR0MsQ0FBQSIsImZpbGUiOiJpbmRleC5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIFByb21pc2UgZnJvbSAnYmx1ZWJpcmQnO1xuXG5cbmltcG9ydCAqIGFzIGZzIGZyb20gJ2ZzJztcblxuXG5pbXBvcnQgU3lzU2VydmljZSBmcm9tICdzeXN0ZW1kLXNlcnZpY2VzJztcblxuXG5cblxuY29uc3QgbnMgPSBuZXcgU3lzU2VydmljZSgpXG5cbmludGVyZmFjZSBJV2F0Y2hkb2dDb25mIHtcbiAgICBoYXJkd2FyZT86IHN0cmluZztcbiAgICBwaW5ncz86IHN0cmluZ1tdO1xuICAgIGludGVyZmFjZXM/OiBzdHJpbmdbXTtcbiAgICBmaWxlcz86IHtcbiAgICAgICAgbmFtZTogc3RyaW5nO1xuICAgICAgICBjaGFuZ2U6IG51bWJlclxuICAgIH1bXTtcbiAgICBtYXhMb2FkMT86IG51bWJlcjtcbiAgICBtYXhMb2FkNT86IG51bWJlcjtcbiAgICBtYXhMb2FkMTU/OiBudW1iZXI7XG4gICAgbWluTWVtb3J5PzogbnVtYmVyO1xuICAgIGFsbG9jdGFibGVNZW1vcnk/OiBudW1iZXI7XG4gICAgY29uZmlnRmlsZT86IHN0cmluZztcbiAgICBwaWRGaWxlPzogc3RyaW5nO1xuICAgIHJlcGFpckJpbmFyeT86c3RyaW5nO1xufVxuXG5pbnRlcmZhY2UgSVN0YXR1cyB7XG4gICAgYWN0aXZlOiBib29sZWFuO1xuICAgIGFjdGl2ZV9zdGF0dXM6IHN0cmluZztcbn1cblxuZXhwb3J0IGRlZmF1bHQgY2xhc3Mgd2F0Y2hEb2cge1xuICAgIGNvbmZpZ0ZpbGU6IHN0cmluZztcbiAgICBjb25zdHJ1Y3RvcihvPzogSVdhdGNoZG9nQ29uZikge1xuICAgICAgICBpZiAobykgdGhpcy5jb25maWd1cmUobylcbiAgICB9XG5cbiAgICBjb25maWd1cmUobzogSVdhdGNoZG9nQ29uZikge1xuXG4gICAgICAgIGxldCBfdGhpcyA9IHRoaXM7XG5cbiAgICAgICAgaWYgKCFvKSB7XG4gICAgICAgICAgICB0aHJvdyBFcnJvcignbm8gY29uZmlndXJhdGlvbiBwcm92aWRlZCBmb3Igd2F0Y2hkb2cnKVxuICAgICAgICB9IGVsc2Uge1xuXG4gICAgICAgICAgICBpZiAoIW8uY29uZmlnRmlsZSkgby5jb25maWdGaWxlID0gJy9ldGMvd2F0Y2hkb2cuY29uZidcbiAgICAgICAgICAgIF90aGlzLmNvbmZpZ0ZpbGUgPSBvLmNvbmZpZ0ZpbGU7XG5cbiAgICAgICAgICAgIGxldCBjb25mID0gJ3JlYWx0aW1lID0geWVzXFxuJztcbiAgICAgICAgICAgIGNvbmYgKz0gJ3ByaW9yaXR5ID0gMVxcbic7XG5cbiAgICAgICAgICAgIGlmIChvLnBpbmdzKSB7XG4gICAgICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBvLnBpbmdzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbmYgKz0gJ3BpbmcgPSAnICsgby5waW5nc1tpXSArICdcXG4nXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKG8uZmlsZXMpIHtcbiAgICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IG8uZmlsZXMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKG8uZmlsZXNbaV0ubmFtZSAmJiBvLmZpbGVzW2ldLmNoYW5nZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uZiArPSAnZmlsZSA9ICcgKyBvLmZpbGVzW2ldLm5hbWUgKyAnXFxuJ1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uZiArPSAnY2hhbmdlID0gJyArIG8uZmlsZXNbaV0uY2hhbmdlICsgJ1xcbidcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IEVycm9yKCd5b3UgbXVzdCBzcGVjaWZ5IGZpbGVuYW1lIGFuZCBjaGFuZ2UgdGltZXInKVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICB9XG5cblxuXG4gICAgICAgICAgICBpZiAoby5waWRGaWxlKSB7XG4gICAgICAgICAgICAgICAgY29uZiArPSAncGlkZmlsZSA9ICcgKyBvLnBpZEZpbGUgKyAnXFxuJ1xuICAgICAgICAgICAgfVxuXG5cblxuICAgICAgICAgICAgaWYgKG8ucmVwYWlyQmluYXJ5KSB7XG4gICAgICAgICAgICAgICAgY29uZiArPSAncmVwYWlyLWJpbmFyeSA9ICcgKyBvLnJlcGFpckJpbmFyeSArICdcXG4nXG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGZzLndyaXRlRmlsZVN5bmMoX3RoaXMuY29uZmlnRmlsZSwgY29uZiwgeyBlbmNvZGluZzogJ3V0Zi04JyB9KVxuXG5cbiAgICAgICAgfVxuXG5cblxuICAgIH1cblxuICAgIHN0YXJ0KCkge1xuICAgICAgICBjb25zdCBfdGhpcyA9IHRoaXM7XG4gICAgICAgIHJldHVybiBuZXcgUHJvbWlzZTxib29sZWFuPigocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAgICAgICBucy5zdGFydCgnd2F0Y2hkb2cnKS50aGVuKChhKSA9PiB7XG4gICAgICAgICAgICAgICAgcmVzb2x2ZShhKVxuICAgICAgICAgICAgfSkuY2F0Y2goKGVycikgPT4ge1xuICAgICAgICAgICAgICAgIHJlamVjdChlcnIpXG4gICAgICAgICAgICB9KVxuXG4gICAgICAgIH0pXG5cbiAgICB9XG5cblxuICAgIHN0b3AoKSB7XG4gICAgICAgIGNvbnN0IF90aGlzID0gdGhpcztcbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlPGJvb2xlYW4+KChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgICAgIG5zLnN0b3AoJ3dhdGNoZG9nJykudGhlbigoYSkgPT4ge1xuICAgICAgICAgICAgICAgIHJlc29sdmUoYSlcbiAgICAgICAgICAgIH0pLmNhdGNoKChlcnIpID0+IHtcbiAgICAgICAgICAgICAgICByZWplY3QoZXJyKVxuICAgICAgICAgICAgfSlcbiAgICAgICAgfSlcblxuICAgIH1cblxuICAgIHJlc3RhcnQoKSB7XG4gICAgICAgIGNvbnN0IF90aGlzID0gdGhpcztcbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlPGJvb2xlYW4+KChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgICAgIF90aGlzLnN0b3AoKS50aGVuKCgpID0+IHtcbiAgICAgICAgICAgICAgICBfdGhpcy5zdGFydCgpLnRoZW4oKGEpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZShhKVxuICAgICAgICAgICAgICAgIH0pLmNhdGNoKChlcnIpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgcmVqZWN0KGVycilcbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgfSkuY2F0Y2goKGVycikgPT4ge1xuICAgICAgICAgICAgICAgIF90aGlzLnN0YXJ0KCkudGhlbigoYSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICByZXNvbHZlKGEpXG4gICAgICAgICAgICAgICAgfSkuY2F0Y2goKGVycikgPT4ge1xuICAgICAgICAgICAgICAgICAgICByZWplY3QoZXJyKVxuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICB9KVxuXG4gICAgICAgIH0pXG5cbiAgICB9XG5cblxufVxuIl0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9
