"use strict";
var Promise = require('bluebird');
var fs = require('fs');
var systemd_services_1 = require('systemd-services');
var ns = new systemd_services_1.default();
var watchDog = (function () {
    function watchDog(o) {
        if (o)
            this.configure(o);
    }
    watchDog.prototype.configure = function (o) {
        var _this = this;
        if (!o) {
            throw Error('no configuration provided for watchdog');
        }
        else {
            if (!o.configFile)
                o.configFile = '/etc/watchdog.conf';
            _this.configFile = o.configFile;
            var conf = 'realtime = yes\n';
            conf += 'priority = 1\n';
            if (o.pings) {
                for (var i = 0; i < o.pings.length; i++) {
                    conf += 'ping = ' + o.pings[i] + '\n';
                }
            }
            if (o.files) {
                for (var i = 0; i < o.files.length; i++) {
                    if (o.files[i].name && o.files[i].change) {
                        conf += 'file = ' + o.files[i].name + '\n';
                        conf += 'change = ' + o.files[i].change + '\n';
                    }
                    else {
                        throw Error('you must specify filename and change timer');
                    }
                }
            }
            if (o.watchdogDevice) {
                conf += 'watchdog-device = ' + o.watchdogDevice + '\n';
            }
            if (o.pidFile) {
                conf += 'pidfile = ' + o.pidFile + '\n';
            }
            if (o.repairBinary) {
                conf += 'repair-binary = ' + o.repairBinary + '\n';
            }
            fs.writeFileSync(_this.configFile, conf, { encoding: 'utf-8' });
        }
    };
    watchDog.prototype.start = function () {
        var _this = this;
        return new Promise(function (resolve, reject) {
            ns.start('watchdog').then(function (a) {
                resolve(a);
            }).catch(function (err) {
                ns.start('watchdog').then(function (a) {
                    resolve(a);
                }).catch(function (err) {
                    reject(err);
                });
            });
        });
    };
    watchDog.prototype.stop = function () {
        var _this = this;
        return new Promise(function (resolve, reject) {
            ns.stop('watchdog').then(function (a) {
                resolve(a);
            }).catch(function (err) {
                ns.stop('watchdog').then(function (a) {
                    resolve(a);
                }).catch(function (err) {
                    reject(err);
                });
            });
        });
    };
    watchDog.prototype.restart = function () {
        var _this = this;
        return new Promise(function (resolve, reject) {
            _this.stop().then(function () {
                _this.start().then(function (a) {
                    resolve(a);
                }).catch(function (err) {
                    reject(err);
                });
            }).catch(function (err) {
                _this.start().then(function (a) {
                    resolve(a);
                }).catch(function (err) {
                    reject(err);
                });
            });
        });
    };
    return watchDog;
}());
Object.defineProperty(exports, "__esModule", { value: true });
exports.default = watchDog;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImluZGV4LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxJQUFZLE9BQU8sV0FBTSxVQUFVLENBQUMsQ0FBQTtBQUdwQyxJQUFZLEVBQUUsV0FBTSxJQUFJLENBQUMsQ0FBQTtBQUd6QixpQ0FBdUIsa0JBQWtCLENBQUMsQ0FBQTtBQUsxQyxJQUFNLEVBQUUsR0FBRyxJQUFJLDBCQUFVLEVBQUUsQ0FBQTtBQTBCM0I7SUFFSSxrQkFBWSxDQUFpQjtRQUN6QixFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxDQUFBO0lBQzVCLENBQUM7SUFFRCw0QkFBUyxHQUFULFVBQVUsQ0FBZ0I7UUFFdEIsSUFBSSxLQUFLLEdBQUcsSUFBSSxDQUFDO1FBRWpCLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUNMLE1BQU0sS0FBSyxDQUFDLHdDQUF3QyxDQUFDLENBQUE7UUFDekQsQ0FBQztRQUFDLElBQUksQ0FBQyxDQUFDO1lBRUosRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsVUFBVSxDQUFDO2dCQUFDLENBQUMsQ0FBQyxVQUFVLEdBQUcsb0JBQW9CLENBQUE7WUFDdEQsS0FBSyxDQUFDLFVBQVUsR0FBRyxDQUFDLENBQUMsVUFBVSxDQUFDO1lBRWhDLElBQUksSUFBSSxHQUFHLGtCQUFrQixDQUFDO1lBQzlCLElBQUksSUFBSSxnQkFBZ0IsQ0FBQztZQUV6QixFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztnQkFDVixHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLENBQUMsQ0FBQyxLQUFLLENBQUMsTUFBTSxFQUFFLENBQUMsRUFBRSxFQUFFLENBQUM7b0JBQ3RDLElBQUksSUFBSSxTQUFTLEdBQUcsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsR0FBRyxJQUFJLENBQUE7Z0JBQ3pDLENBQUM7WUFDTCxDQUFDO1lBQ0QsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7Z0JBQ1YsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxDQUFDLENBQUMsS0FBSyxDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUFDO29CQUN0QyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksSUFBSSxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUM7d0JBQ3ZDLElBQUksSUFBSSxTQUFTLEdBQUcsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFBO3dCQUMxQyxJQUFJLElBQUksV0FBVyxHQUFHLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsTUFBTSxHQUFHLElBQUksQ0FBQTtvQkFDbEQsQ0FBQztvQkFBQyxJQUFJLENBQUMsQ0FBQzt3QkFDSixNQUFNLEtBQUssQ0FBQyw0Q0FBNEMsQ0FBQyxDQUFBO29CQUM3RCxDQUFDO2dCQUNMLENBQUM7WUFFTCxDQUFDO1lBSUQsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLGNBQWMsQ0FBQyxDQUFDLENBQUM7Z0JBQ25CLElBQUksSUFBSSxvQkFBb0IsR0FBRyxDQUFDLENBQUMsY0FBYyxHQUFHLElBQUksQ0FBQTtZQUMxRCxDQUFDO1lBRUQsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUM7Z0JBQ1osSUFBSSxJQUFJLFlBQVksR0FBRyxDQUFDLENBQUMsT0FBTyxHQUFHLElBQUksQ0FBQTtZQUMzQyxDQUFDO1lBR0QsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLFlBQVksQ0FBQyxDQUFDLENBQUM7Z0JBQ2pCLElBQUksSUFBSSxrQkFBa0IsR0FBRyxDQUFDLENBQUMsWUFBWSxHQUFHLElBQUksQ0FBQTtZQUN0RCxDQUFDO1lBRUQsRUFBRSxDQUFDLGFBQWEsQ0FBQyxLQUFLLENBQUMsVUFBVSxFQUFFLElBQUksRUFBRSxFQUFFLFFBQVEsRUFBRSxPQUFPLEVBQUUsQ0FBQyxDQUFBO1FBR25FLENBQUM7SUFJTCxDQUFDO0lBRUQsd0JBQUssR0FBTDtRQUNJLElBQU0sS0FBSyxHQUFHLElBQUksQ0FBQztRQUNuQixNQUFNLENBQUMsSUFBSSxPQUFPLENBQVUsVUFBQyxPQUFPLEVBQUUsTUFBTTtZQUN4QyxFQUFFLENBQUMsS0FBSyxDQUFDLFVBQVUsQ0FBQyxDQUFDLElBQUksQ0FBQyxVQUFDLENBQUM7Z0JBQ3hCLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQTtZQUNkLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxVQUFDLEdBQUc7Z0JBQ1QsRUFBRSxDQUFDLEtBQUssQ0FBQyxVQUFVLENBQUMsQ0FBQyxJQUFJLENBQUMsVUFBQyxDQUFDO29CQUN4QixPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUE7Z0JBQ2QsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLFVBQUMsR0FBRztvQkFDVCxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUE7Z0JBQ2YsQ0FBQyxDQUFDLENBQUE7WUFDTixDQUFDLENBQUMsQ0FBQTtRQUVOLENBQUMsQ0FBQyxDQUFBO0lBRU4sQ0FBQztJQUdELHVCQUFJLEdBQUo7UUFDSSxJQUFNLEtBQUssR0FBRyxJQUFJLENBQUM7UUFDbkIsTUFBTSxDQUFDLElBQUksT0FBTyxDQUFVLFVBQUMsT0FBTyxFQUFFLE1BQU07WUFDeEMsRUFBRSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQyxJQUFJLENBQUMsVUFBQyxDQUFDO2dCQUN2QixPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUE7WUFDZCxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsVUFBQyxHQUFHO2dCQUNULEVBQUUsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUMsSUFBSSxDQUFDLFVBQUMsQ0FBQztvQkFDdkIsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFBO2dCQUNkLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxVQUFDLEdBQUc7b0JBQ1QsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFBO2dCQUNmLENBQUMsQ0FBQyxDQUFBO1lBQ04sQ0FBQyxDQUFDLENBQUE7UUFDTixDQUFDLENBQUMsQ0FBQTtJQUVOLENBQUM7SUFFRCwwQkFBTyxHQUFQO1FBQ0ksSUFBTSxLQUFLLEdBQUcsSUFBSSxDQUFDO1FBQ25CLE1BQU0sQ0FBQyxJQUFJLE9BQU8sQ0FBVSxVQUFDLE9BQU8sRUFBRSxNQUFNO1lBQ3hDLEtBQUssQ0FBQyxJQUFJLEVBQUUsQ0FBQyxJQUFJLENBQUM7Z0JBQ2QsS0FBSyxDQUFDLEtBQUssRUFBRSxDQUFDLElBQUksQ0FBQyxVQUFDLENBQUM7b0JBQ2pCLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQTtnQkFDZCxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsVUFBQyxHQUFHO29CQUNULE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQTtnQkFDZixDQUFDLENBQUMsQ0FBQTtZQUNOLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxVQUFDLEdBQUc7Z0JBQ1QsS0FBSyxDQUFDLEtBQUssRUFBRSxDQUFDLElBQUksQ0FBQyxVQUFDLENBQUM7b0JBQ2pCLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQTtnQkFDZCxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsVUFBQyxHQUFHO29CQUNULE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQTtnQkFDZixDQUFDLENBQUMsQ0FBQTtZQUNOLENBQUMsQ0FBQyxDQUFBO1FBRU4sQ0FBQyxDQUFDLENBQUE7SUFFTixDQUFDO0lBR0wsZUFBQztBQUFELENBckhBLEFBcUhDLElBQUE7QUFySEQ7MEJBcUhDLENBQUEiLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBQcm9taXNlIGZyb20gJ2JsdWViaXJkJztcblxuXG5pbXBvcnQgKiBhcyBmcyBmcm9tICdmcyc7XG5cblxuaW1wb3J0IFN5c1NlcnZpY2UgZnJvbSAnc3lzdGVtZC1zZXJ2aWNlcyc7XG5cblxuXG5cbmNvbnN0IG5zID0gbmV3IFN5c1NlcnZpY2UoKVxuXG5pbnRlcmZhY2UgSVdhdGNoZG9nQ29uZiB7XG4gICAgaGFyZHdhcmU/OiBzdHJpbmc7XG4gICAgcGluZ3M/OiBzdHJpbmdbXTtcbiAgICBpbnRlcmZhY2VzPzogc3RyaW5nW107XG4gICAgZmlsZXM/OiB7XG4gICAgICAgIG5hbWU6IHN0cmluZztcbiAgICAgICAgY2hhbmdlOiBudW1iZXJcbiAgICB9W107XG4gICAgbWF4TG9hZDE/OiBudW1iZXI7XG4gICAgbWF4TG9hZDU/OiBudW1iZXI7XG4gICAgbWF4TG9hZDE1PzogbnVtYmVyO1xuICAgIG1pbk1lbW9yeT86IG51bWJlcjtcbiAgICBhbGxvY3RhYmxlTWVtb3J5PzogbnVtYmVyO1xuICAgIGNvbmZpZ0ZpbGU/OiBzdHJpbmc7XG4gICAgcGlkRmlsZT86IHN0cmluZztcbiAgICByZXBhaXJCaW5hcnk/OiBzdHJpbmc7XG4gICAgd2F0Y2hkb2dEZXZpY2U/OiBzdHJpbmc7XG59XG5cbmludGVyZmFjZSBJU3RhdHVzIHtcbiAgICBhY3RpdmU6IGJvb2xlYW47XG4gICAgYWN0aXZlX3N0YXR1czogc3RyaW5nO1xufVxuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyB3YXRjaERvZyB7XG4gICAgY29uZmlnRmlsZTogc3RyaW5nO1xuICAgIGNvbnN0cnVjdG9yKG8/OiBJV2F0Y2hkb2dDb25mKSB7XG4gICAgICAgIGlmIChvKSB0aGlzLmNvbmZpZ3VyZShvKVxuICAgIH1cblxuICAgIGNvbmZpZ3VyZShvOiBJV2F0Y2hkb2dDb25mKSB7XG5cbiAgICAgICAgbGV0IF90aGlzID0gdGhpcztcblxuICAgICAgICBpZiAoIW8pIHtcbiAgICAgICAgICAgIHRocm93IEVycm9yKCdubyBjb25maWd1cmF0aW9uIHByb3ZpZGVkIGZvciB3YXRjaGRvZycpXG4gICAgICAgIH0gZWxzZSB7XG5cbiAgICAgICAgICAgIGlmICghby5jb25maWdGaWxlKSBvLmNvbmZpZ0ZpbGUgPSAnL2V0Yy93YXRjaGRvZy5jb25mJ1xuICAgICAgICAgICAgX3RoaXMuY29uZmlnRmlsZSA9IG8uY29uZmlnRmlsZTtcblxuICAgICAgICAgICAgbGV0IGNvbmYgPSAncmVhbHRpbWUgPSB5ZXNcXG4nO1xuICAgICAgICAgICAgY29uZiArPSAncHJpb3JpdHkgPSAxXFxuJztcblxuICAgICAgICAgICAgaWYgKG8ucGluZ3MpIHtcbiAgICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IG8ucGluZ3MubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgY29uZiArPSAncGluZyA9ICcgKyBvLnBpbmdzW2ldICsgJ1xcbidcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoby5maWxlcykge1xuICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgby5maWxlcy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgICAgICBpZiAoby5maWxlc1tpXS5uYW1lICYmIG8uZmlsZXNbaV0uY2hhbmdlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25mICs9ICdmaWxlID0gJyArIG8uZmlsZXNbaV0ubmFtZSArICdcXG4nXG4gICAgICAgICAgICAgICAgICAgICAgICBjb25mICs9ICdjaGFuZ2UgPSAnICsgby5maWxlc1tpXS5jaGFuZ2UgKyAnXFxuJ1xuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgRXJyb3IoJ3lvdSBtdXN0IHNwZWNpZnkgZmlsZW5hbWUgYW5kIGNoYW5nZSB0aW1lcicpXG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIH1cblxuXG5cbiAgICAgICAgICAgIGlmIChvLndhdGNoZG9nRGV2aWNlKSB7XG4gICAgICAgICAgICAgICAgY29uZiArPSAnd2F0Y2hkb2ctZGV2aWNlID0gJyArIG8ud2F0Y2hkb2dEZXZpY2UgKyAnXFxuJ1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAoby5waWRGaWxlKSB7XG4gICAgICAgICAgICAgICAgY29uZiArPSAncGlkZmlsZSA9ICcgKyBvLnBpZEZpbGUgKyAnXFxuJ1xuICAgICAgICAgICAgfVxuXG5cbiAgICAgICAgICAgIGlmIChvLnJlcGFpckJpbmFyeSkge1xuICAgICAgICAgICAgICAgIGNvbmYgKz0gJ3JlcGFpci1iaW5hcnkgPSAnICsgby5yZXBhaXJCaW5hcnkgKyAnXFxuJ1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBmcy53cml0ZUZpbGVTeW5jKF90aGlzLmNvbmZpZ0ZpbGUsIGNvbmYsIHsgZW5jb2Rpbmc6ICd1dGYtOCcgfSlcblxuXG4gICAgICAgIH1cblxuXG5cbiAgICB9XG5cbiAgICBzdGFydCgpIHtcbiAgICAgICAgY29uc3QgX3RoaXMgPSB0aGlzO1xuICAgICAgICByZXR1cm4gbmV3IFByb21pc2U8Ym9vbGVhbj4oKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICAgICAgbnMuc3RhcnQoJ3dhdGNoZG9nJykudGhlbigoYSkgPT4ge1xuICAgICAgICAgICAgICAgIHJlc29sdmUoYSlcbiAgICAgICAgICAgIH0pLmNhdGNoKChlcnIpID0+IHtcbiAgICAgICAgICAgICAgICBucy5zdGFydCgnd2F0Y2hkb2cnKS50aGVuKChhKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHJlc29sdmUoYSlcbiAgICAgICAgICAgICAgICB9KS5jYXRjaCgoZXJyKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHJlamVjdChlcnIpXG4gICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIH0pXG5cbiAgICAgICAgfSlcblxuICAgIH1cblxuXG4gICAgc3RvcCgpIHtcbiAgICAgICAgY29uc3QgX3RoaXMgPSB0aGlzO1xuICAgICAgICByZXR1cm4gbmV3IFByb21pc2U8Ym9vbGVhbj4oKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICAgICAgbnMuc3RvcCgnd2F0Y2hkb2cnKS50aGVuKChhKSA9PiB7XG4gICAgICAgICAgICAgICAgcmVzb2x2ZShhKVxuICAgICAgICAgICAgfSkuY2F0Y2goKGVycikgPT4ge1xuICAgICAgICAgICAgICAgIG5zLnN0b3AoJ3dhdGNoZG9nJykudGhlbigoYSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICByZXNvbHZlKGEpXG4gICAgICAgICAgICAgICAgfSkuY2F0Y2goKGVycikgPT4ge1xuICAgICAgICAgICAgICAgICAgICByZWplY3QoZXJyKVxuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICB9KVxuICAgICAgICB9KVxuXG4gICAgfVxuXG4gICAgcmVzdGFydCgpIHtcbiAgICAgICAgY29uc3QgX3RoaXMgPSB0aGlzO1xuICAgICAgICByZXR1cm4gbmV3IFByb21pc2U8Ym9vbGVhbj4oKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICAgICAgX3RoaXMuc3RvcCgpLnRoZW4oKCkgPT4ge1xuICAgICAgICAgICAgICAgIF90aGlzLnN0YXJ0KCkudGhlbigoYSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICByZXNvbHZlKGEpXG4gICAgICAgICAgICAgICAgfSkuY2F0Y2goKGVycikgPT4ge1xuICAgICAgICAgICAgICAgICAgICByZWplY3QoZXJyKVxuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICB9KS5jYXRjaCgoZXJyKSA9PiB7XG4gICAgICAgICAgICAgICAgX3RoaXMuc3RhcnQoKS50aGVuKChhKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHJlc29sdmUoYSlcbiAgICAgICAgICAgICAgICB9KS5jYXRjaCgoZXJyKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHJlamVjdChlcnIpXG4gICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIH0pXG5cbiAgICAgICAgfSlcblxuICAgIH1cblxuXG59XG4iXX0=
